
{% extends 'base.html' %}

{% block content %}

<div class="section-header">
    <h2>Инцидент #{{ incident.id }}</h2>
    <p>Подробная информация и управление в зависимости от роли.</p>
</div>

<div class="detail-card mb-4">
    <dl class="detail-list">
        <div class="detail-row">
            <dt>Услуга</dt>
            <dd>{{ incident.service.name }}</dd>
        </div>

        <div class="detail-row">
            <dt>Статус</dt>
            <dd>
                {% if incident.status == 'new' %}
                    <span class="badge badge-status-new">Новый</span>
                {% elif incident.status == 'in_progress' %}
                    <span class="badge badge-status-in-progress">В работе</span>
                {% elif incident.status == 'done' %}
                    <span class="badge badge-status-done">Выполнен</span>
                {% elif incident.status == 'cancelled' %}
                    <span class="badge badge-status-cancelled">Отменён</span>
                {% else %}
                    {{ incident.status }}
                {% endif %}
            </dd>
        </div>

        <div class="detail-row">
            <dt>Создан</dt>
            <dd>{{ incident.created_at }}</dd>
        </div>

        <div class="detail-row">
            <dt>Автор</dt>
            <dd>{{ incident.created_by|default:"Гость" }}</dd>
        </div>

        <div class="detail-row">
            <dt>Ответственный</dt>
            <dd>
                {% if incident.assigned_to %}
                    {{ incident.assigned_to.username }}
                {% else %}
                    <span class="text-muted">Не назначен</span>
                {% endif %}
            </dd>
        </div>

        <div class="detail-row">
            <dt>Комментарий пользователя</dt>
            <dd>{{ incident.comment|linebreaksbr }}</dd>
        </div>
    </dl>
</div>

<hr>

{# Блок назначения техника: только для администратора #}
{% if can_assign and techs %}
    <section class="mb-4">
        <h3>Назначить техника</h3>
        <form method="post" class="form-card">
            {% csrf_token %}
            <input type="hidden" name="action" value="assign">

            <label for="assigned_to">Техник:</label>
            <select id="assigned_to" name="assigned_to">
                <option value="">Не назначено</option>
                {% for tech in techs %}
                    <option value="{{ tech.id }}" {% if incident.assigned_to and tech.id == incident.assigned_to.id %}selected{% endif %}>
                        {{ tech.username }}
                    </option>
                {% endfor %}
            </select>

            <button class="btn btn-primary btn-full mt-3">Сохранить назначение</button>
        </form>
    </section>
{% endif %}

{# Блок изменения статуса: для админа и тех. специалиста #}
{% if can_edit %}
    <section class="mb-4">
        <h3>Изменить статус</h3>
        <form method="post" class="form-card">
            {% csrf_token %}

            <label for="status">Новый статус:</label>
            <select name="status" id="status">
                {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if value == incident.status %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>

            <button class="btn btn-success btn-full mt-3">Обновить статус</button>
        </form>
    </section>
{% else %}
    <p class="text-muted">
        У вас нет прав на изменение статуса данного инцидента. Доступен только просмотр.
    </p>
{% endif %}

<hr>

<a href="{% url 'service_desk:incidents_list' %}" class="btn btn-secondary mt-3">Назад к списку</a>

{% endblock %}
